---
title: "Study *Tidy Finance with R*"
author: "Shitao"
date: "`r Sys.Date()`"
output:
  rmdformats::downcute:
    self_contained: true
    default_style: "light"
    downcute_theme: "default"
    number_sections: true
    code_folding: "show"
    css: "style.css"
    code_download: true
    includes:
      before_body: header.html
      after_body: footer.html
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      fig.align = "center",
                      fig.asp = 0.618,
                      comment = "#>",
                      collapse = TRUE,
                      cache = TRUE)
options(digits = 3)
```

# Introduction {.unnumbered}

è¿™æ˜¯[Tidy Finance with R](https://www.tidy-finance.org)çš„å­¦ä¹ è®°å½•ï¼Œä½¿ç”¨çš„Rè½¯ä»¶ç‰ˆæœ¬ä¸º`r paste0(version$major, ".", version$minor)`ï¼ˆ`r paste(version$year, version$month, version$day, sep = "-")`ï¼‰ï¼Œä¸‹è½½æºç [^code]å¯ç‚¹å‡»é¡µé¢æœ€é¡¶ç«¯æ ‡é¢˜å³ä¾§â€œCode > Download Rmdâ€ã€‚

[^code]: åœ¨å®‰è£…åæ‰€éœ€çš„åŒ…åï¼Œè¿è¡Œæºç å¯ç”Ÿæˆè¯¥æ–‡ä»¶çš„æ–‡æœ¬å†…å®¹ã€‚ç”±äºé…ç½®äº†cssç­‰æ ·å¼æ–‡ä»¶ï¼Œå¦‚æœéœ€è¦å®Œå…¨é‡ç°è¯¥æ–‡ä»¶ï¼Œè¯·åœ¨[Github](https://github.com/Shitao5/tidy-finance)ä¸‹è½½è¯¥ä»“åº“åè¿›è¡ŒKnitã€‚

å¯¹å†…å®¹æœ‰ç–‘é—®æˆ–å»ºè®®çš„å°ä¼™ä¼´ï¼Œæ¬¢è¿åœ¨[è¿™é‡Œ](https://github.com/Shitao5/tidy-finance)æäº¤Issuesæˆ–è€…Pull requestsï¼Œå¸®åŠ©å®Œå–„ï¼Œåœ¨ä¸‹å…ˆè¡Œè°¢è¿‡äº†ã€‚ğŸ¤ğŸ¤

# Introduction to Tidy Finance

è¯´åˆ°Tidyï¼ˆæ•´æ´ï¼‰ï¼Œé¦–å…ˆåŠ è½½ä¸¤ä¸ªtidyå¼€å¤´çš„åŒ…ï¼š

```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(tidyquant)
```

```{r include=FALSE}
# ggplot2 global theme
theme_set(theme_bw() + theme(legend.position = "bottom"))
```


è¿™é‡Œè¡¥å……ä¸€ä¸‹ç®¡é“æ“ä½œç¬¦`%>%`çš„çŸ¥è¯†ï¼Œå…¶ä½œç”¨æ˜¯å°†å‰ä¸€æ­¥ç”Ÿæˆçš„ç»“æœä½œä¸ºä¸‹ä¸€æ­¥å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°[^pipe]ï¼š

[^pipe]: ä¹Ÿå¯ä»¥ä¸æ˜¯ç¬¬ä¸€ä¸ªï¼Œè¿™é‡Œå…ˆæŒ‰ä¸‹ä¸è¡¨ã€‚
<!-- ğŸ’¥è®°å¾—åˆ°éœ€è¦çš„æ—¶å€™éœ€è¦è¡¨çš„å“ˆï¼ğŸ’¥ -->

- `x %>% f()`ç­‰åŒäº`f(x)`
- `x %>% f(y)`ç­‰åŒäº`f(x, y)`
- `x %>% f() %>% g()`ç­‰åŒäº`g(f(x))`
- `f(x) %>% g(y) %>% t(z)`ç­‰åŒäº`t(g(f(x), y), z)`

æ˜¯ä¸æ˜¯æœ‰ç‚¹åƒâ€œç„¶åâ€çš„æ„æ€ï¼Ÿå®ƒå¯ä»¥è®©å†™ä»£ç ã€è¯»ä»£ç éƒ½å®‰è£…ä»ä¸Šåˆ°ä¸‹ã€ä»å·¦åˆ°å³çš„é¡ºåºä¸€æ­¥ä¸€æ­¥åœ°è¿›è¡Œï¼Œä¸”ä¸ä¼šç”Ÿæˆå¾ˆå¤šçš„ä¸­é—´å˜é‡ï¼Œå¤§éƒ¨åˆ†æ—¶å€™å¯ä»¥ä»æ•°æ®åˆ°ç»“æœâ€œä¸€ç®¡åˆ°åº•â€ï¼Œå¤§å¤§å¢åŠ æ•°æ®åˆ†æçš„æµç•…æ€§ã€‚å¿«æ·é”®ä¸º`Ctrl + Shift + M`ã€‚

æ£ç€è¿™ä¸ªæ•ˆç‡ç¥å™¨ï¼Œæˆ‘ä»¬å‡ºå‘ï¼ğŸš€

## è‚¡ç¥¨æ•°æ®

è¯»å–è‹¹æœå…¬å¸è‚¡ç¥¨ä»·æ ¼æ•°æ®ï¼Œ`tq_get()`å‡½æ•°é»˜è®¤ä½¿ç”¨é›…è™æ•°æ®åº“ï¼Œå› æ­¤åœ¨å›½å†…éœ€è¦è¿æ¥å¤–ç½‘åä½¿ç”¨[^rstudio-cloud]ã€‚

[^rstudio-cloud]: ä¹Ÿå¯ä»¥ä½¿ç”¨[RStudio Cloud](https://rstudio.cloud)è¿è¡Œä»£ç ã€‚

```{r data-price, eval=FALSE, include=FALSE}
# å¦‚ä¸èƒ½è¿æ¥å¤–ç½‘ï¼Œè¯·è¿è¡Œè¿™ä¸ªä»£ç å—ã€‚
# save(price, file = "data/price.rda")
load("data/price.rda")
```


```{r}
price <- tq_get("AAPL", # Apple Stock
                get = "stock.price",
                from = "2000-01-01",
                to = "2022-06-30")
price
```

ç®€å•çš„å¯è§†åŒ–ï¼Œå‘ˆç°ä»·æ ¼èµ°åŠ¿ï¼š

```{r fig_AAPL}
price %>% 
  ggplot(aes(date, adjusted)) +
  geom_line() +
  labs(x = NULL, y = NULL,
       title = "AAPL stock prices",
       subtitle = "Prices in USD, adjusted for dividend payments and stock splits")
```

## æ—¥æ”¶ç›Šç‡ï¼ˆDaily Returnï¼‰

\begin{equation}
\text{daily return} = \frac{p_t - p_{t-1}}{p_{t-1}} = \frac{p_t}{p_{t-1}} - 1
\end{equation}

æ ¹æ®ä»¥ä¸Šå…¬å¼ï¼Œç”¨è°ƒæ•´åä»·æ ¼è®¡ç®—æ—¥æ”¶ç›Šç‡ï¼š

```{r}
returns <- price %>% 
  arrange(date) %>% 
  mutate(ret = adjusted / lag(adjusted) - 1) %>% 
  select(symbol, date, ret)
returns
```

è®¡ç®—å‰éœ€å…ˆå°†æ•°æ®æ ¹æ®æ—¥æœŸæ’åºï¼Œç”±äº`r dplyr::arrange(price, date)$date[1]`ä¸ºç¬¬ä¸€å¤©ï¼Œå› æ­¤è®¡ç®—æ”¶ç›Šç‡æ—¶äº§ç”Ÿç¼ºå¤±å€¼(NA)ï¼Œåœ¨è¿™é‡Œå¯ä»¥ç›´æ¥å‰”é™¤ï¼š

```{r}
returns <- returns %>% 
  drop_na(ret)
```

å¯¹æ—¥æ”¶ç›Šç‡è¿›è¡Œæ±‡æ€»ç»Ÿè®¡ï¼š

```{r}
summary(returns$ret)
```

å¯ä»¥çœ‹åˆ°æœ€é«˜æ—¥æ”¶ç›Šç‡ä¸º`r max(returns$ret) * 100`%ï¼Œæœ€ä½æ—¥æ”¶ç›Šè¾¾åˆ°`r min(returns$ret) * 100`%~~ï¼ˆè‚¡æ°‘è½æ³ªï¼‰~~ï¼Œè€Œå¹³å‡æ—¥æ”¶ç›Šç‡ä¸º`r mean(returns$ret) * 100`%ï¼Œç•¥é«˜äº0%ã€‚

ç»˜åˆ¶æ—¥æ”¶ç›Šç‡æŸ±çŠ¶å›¾ï¼Œæ›´ç›´è§‚åœ°å±•ç¤ºæ•°æ®ã€‚å›¾ä¸­çš„çº¢è‰²ç«–çº¿ä»£è¡¨æ—¥æ”¶ç›Šç‡çš„5%åˆ†ä½æ•°ï¼ˆ`r quantile(returns$ret, .05)`ï¼‰[^risk]ã€‚

[^risk]: 5%åˆ†ä½æ•°ä¸é£é™©ä»·å€¼å¯†åˆ‡ç›¸å…³ï¼Œä¹Ÿæ˜¯ç›‘ç®¡æœºæ„é€šå¸¸ç›‘æ§çš„é£é™©è¯„ä¼°ã€‚

```{r fig_ret}
quantile_05 <- quantile(returns$ret, .05)

returns %>% 
  ggplot(aes(ret)) +
  geom_histogram(bins = 100) +
  geom_vline(aes(xintercept = quantile_05),
             color = "red", linetype = "dashed") +
  scale_x_continuous(labels = scales::percent) +
  labs(x = NULL, y = NULL,
       title = "Distribution of daily AAPL return",
       subtitle = "The dotted vertical line indicates the historical 5% quantile")
```

æŒ‰å¹´åˆ†ç»„åï¼Œå¯¹æ—¥æ”¶ç›Šç‡è¿›è¡Œåˆ†ç»„ç»Ÿè®¡ï¼š

```{r paged.print=TRUE}
returns %>%
  mutate(ret = ret * 100) %>%
  group_by(year = year(date)) %>%
  summarise(across(ret,
    list(
      daily_mean = mean,
      daily_sd = sd,
      daily_min = min,
      daily_max = max
    ),
    .names = "{.fn}"
  )) %>% 
  print(n = Inf)
```






