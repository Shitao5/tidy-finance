---
title: "Study *Tidy Finance with R*"
author: "Shitao"
date: "`r Sys.Date()`"
output:
  rmdformats::downcute:
    use_bookdown: true
    self_contained: true
    default_style: "light"
    downcute_theme: "default"
    number_sections: true
    code_folding: "show"
    css: "style.css"
    code_download: true
    includes:
      before_body: header.html
      after_body: footer.html
bibliography: references.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      fig.align = "center",
                      fig.asp = 0.618,
                      comment = "#>",
                      collapse = TRUE,
                      cache = TRUE)

options(digits = 3)

rmdformats::downcute(
  use_bookdown = TRUE
)

# ggplot2 global theme
library(ggplot2)
theme_set(theme_bw() + theme(legend.position = "bottom"))
```

```{r data-load, eval=FALSE, include=FALSE}
# å¦‚ä¸èƒ½è¿æ¥å¤–ç½‘ï¼Œè¯·è¿è¡Œè¿™ä¸ªä»£ç å—ã€‚
load("datas.rds")
```

# Introduction {.unnumbered}

è¿™æ˜¯[Tidy Finance with R](https://www.tidy-finance.org)çš„å­¦ä¹ è®°å½•ï¼Œä½¿ç”¨çš„Rè½¯ä»¶ç‰ˆæœ¬ä¸º`r paste0(version$major, ".", version$minor)`ï¼ˆ`r paste(version$year, version$month, version$day, sep = "-")`ï¼‰ï¼Œä¸‹è½½æºç [^1]å¯ç‚¹å‡»é¡µé¢æœ€é¡¶ç«¯æ ‡é¢˜å³ä¾§"Code \> Download Rmd"ã€‚

[^1]: åœ¨å®‰è£…åæ‰€éœ€çš„åŒ…åï¼Œè¿è¡Œæºç å¯ç”Ÿæˆè¯¥æ–‡ä»¶çš„æ–‡æœ¬å†…å®¹ã€‚ç”±äºé…ç½®äº†cssç­‰æ ·å¼æ–‡ä»¶ï¼Œå¦‚æœéœ€è¦å®Œå…¨é‡ç°è¯¥æ–‡ä»¶ï¼Œè¯·åœ¨[Github](https://github.com/Shitao5/tidy-finance)ä¸‹è½½è¯¥ä»“åº“åè¿›è¡ŒKnitã€‚

å¯¹å†…å®¹æœ‰ç–‘é—®æˆ–å»ºè®®çš„å°ä¼™ä¼´ï¼Œæ¬¢è¿åœ¨[è¿™é‡Œ](https://github.com/Shitao5/tidy-finance)æäº¤Issuesæˆ–è€…Pull requestsï¼Œå¸®åŠ©å®Œå–„ï¼Œåœ¨ä¸‹å…ˆè¡Œè°¢è¿‡äº†ã€‚ğŸ¤ğŸ¤

# Introduction to Tidy Finance

è¯´åˆ°Tidyï¼ˆæ•´æ´ï¼‰ï¼Œé¦–å…ˆåŠ è½½ä¸¤ä¸ªtidyå¼€å¤´çš„åŒ…ï¼š

```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(tidyquant)
```

è¿™é‡Œè¡¥å……ä¸€ä¸‹ç®¡é“æ“ä½œç¬¦`%>%`çš„çŸ¥è¯†ï¼Œå…¶ä½œç”¨æ˜¯å°†å‰ä¸€æ­¥ç”Ÿæˆçš„ç»“æœä½œä¸ºä¸‹ä¸€æ­¥å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°[^2]ï¼š

[^2]: ä¹Ÿå¯ä»¥ä¸æ˜¯ç¬¬ä¸€ä¸ªï¼Œè¿™é‡Œå…ˆæŒ‰ä¸‹ä¸è¡¨ã€‚ <!-- ğŸ’¥è®°å¾—åˆ°éœ€è¦çš„æ—¶å€™è¡¨çš„å“ˆï¼ğŸ’¥ -->

-   `x %>% f()`ç­‰åŒäº`f(x)`
-   `x %>% f(y)`ç­‰åŒäº`f(x, y)`
-   `x %>% f() %>% g()`ç­‰åŒäº`g(f(x))`
-   `f(x) %>% g(y) %>% t(z)`ç­‰åŒäº`t(g(f(x), y), z)`

æ˜¯ä¸æ˜¯æœ‰ç‚¹åƒ"ç„¶å"çš„æ„æ€ï¼Ÿå®ƒå¯ä»¥è®©å†™ä»£ç ã€è¯»ä»£ç éƒ½å®‰è£…ä»ä¸Šåˆ°ä¸‹ã€ä»å·¦åˆ°å³çš„é¡ºåºä¸€æ­¥ä¸€æ­¥åœ°è¿›è¡Œï¼Œä¸”ä¸ä¼šç”Ÿæˆå¾ˆå¤šçš„ä¸­é—´å˜é‡ï¼Œå¤§éƒ¨åˆ†æ—¶å€™å¯ä»¥ä»æ•°æ®åˆ°ç»“æœ"ä¸€ç®¡åˆ°åº•"ï¼Œå¤§å¤§å¢åŠ æ•°æ®åˆ†æçš„æµç•…æ€§ã€‚å¿«æ·é”®ä¸º`Ctrl + Shift + M`ã€‚

æ£ç€è¿™ä¸ªæ•ˆç‡ç¥å™¨ï¼Œæˆ‘ä»¬å‡ºå‘ï¼ğŸš€

## å•ä¸ªè‚¡ç¥¨åˆ†æ

è¯»å–è‹¹æœå…¬å¸è‚¡ç¥¨ä»·æ ¼æ•°æ®ï¼Œ`tq_get()`å‡½æ•°é»˜è®¤ä½¿ç”¨é›…è™æ•°æ®åº“ï¼Œå› æ­¤åœ¨å›½å†…éœ€è¦è¿æ¥å¤–ç½‘åä½¿ç”¨[^3]ã€‚

[^3]: æˆ–è€…ä½¿ç”¨[RStudio Cloud](https://rstudio.cloud)è¿è¡Œä»£ç ã€‚

```{r data-price, eval=FALSE, include=FALSE}
# å¦‚ä¸èƒ½è¿æ¥å¤–ç½‘ï¼Œè¯·è¿è¡Œè¿™ä¸ªä»£ç å—ã€‚
# save(price, file = "data/price.rda")
load("data/price.rda")
```

```{r}
price <- tq_get("AAPL", # Apple Stock
                get = "stock.price",
                from = "2000-01-01",
                to = "2022-06-30")
price
```

ç®€å•çš„å¯è§†åŒ–ï¼Œå‘ˆç°ä»·æ ¼èµ°åŠ¿ï¼š

```{r fig_AAPL}
price %>% 
  ggplot(aes(date, adjusted)) +
  geom_line() +
  labs(x = NULL, y = NULL,
       title = "AAPL stock prices",
       subtitle = "Prices in USD, adjusted for dividend payments and stock splits")
```

æ ¹æ®ä»¥ä¸‹å…¬å¼ï¼Œç”¨è°ƒæ•´åä»·æ ¼è®¡ç®—æ—¥æ”¶ç›Šç‡ï¼ˆDaily Returnï¼‰ã€‚

```{=tex}
\begin{equation}
\text{daily return} = \frac{p_t - p_{t-1}}{p_{t-1}} = \frac{p_t}{p_{t-1}} - 1
\end{equation}
```
è®¡ç®—å‰éœ€å…ˆå°†æ•°æ®æ ¹æ®æ—¥æœŸæ’åºï¼Œç”±äº`r dplyr::arrange(price, date)$date[1]`ä¸ºç¬¬ä¸€å¤©ï¼Œå› æ­¤è®¡ç®—æ”¶ç›Šç‡æ—¶äº§ç”Ÿç¼ºå¤±å€¼(NA)ï¼Œå¯ä»¥ç›´æ¥å‰”é™¤ã€‚

```{r}
returns <- price %>% 
  arrange(date) %>% 
  mutate(ret = adjusted / lag(adjusted) - 1) %>% 
  select(symbol, date, ret) %>% 
  drop_na(ret)
returns
```

å¯¹æ—¥æ”¶ç›Šç‡è¿›è¡Œæ±‡æ€»ç»Ÿè®¡ï¼š

```{r}
summary(returns$ret)
```

å¯ä»¥çœ‹åˆ°æœ€é«˜æ—¥æ”¶ç›Šç‡ä¸º`r max(returns$ret) * 100`%ï¼Œæœ€ä½æ—¥æ”¶ç›Šè¾¾åˆ°`r min(returns$ret) * 100`%ï¼Œè€Œå¹³å‡æ—¥æ”¶ç›Šç‡ä¸º`r mean(returns$ret) * 100`%ï¼Œç•¥é«˜äº0%ã€‚

ç»˜åˆ¶æ—¥æ”¶ç›Šç‡æŸ±çŠ¶å›¾ï¼Œæ›´ç›´è§‚åœ°å±•ç¤ºæ•°æ®ã€‚å›¾ä¸­çš„çº¢è‰²ç«–çº¿ä»£è¡¨æ—¥æ”¶ç›Šç‡çš„5%åˆ†ä½æ•°ï¼ˆ`r quantile(returns$ret, .05)`ï¼‰[^4]ã€‚

[^4]: 5%åˆ†ä½æ•°ä¸é£é™©ä»·å€¼å¯†åˆ‡ç›¸å…³ï¼Œä¹Ÿæ˜¯ç›‘ç®¡æœºæ„é€šå¸¸ç›‘æ§çš„é£é™©è¯„ä¼°ã€‚

```{r fig_ret}
quantile_05 <- quantile(returns$ret, .05)

returns %>% 
  ggplot(aes(ret)) +
  geom_histogram(bins = 100) +
  geom_vline(aes(xintercept = quantile_05),
             color = "red", linetype = "dashed") +
  scale_x_continuous(labels = scales::percent) +
  labs(x = NULL, y = NULL,
       title = "Distribution of daily AAPL return",
       subtitle = "The dotted vertical line indicates the historical 5% quantile")
```

æŒ‰å¹´åˆ†ç»„åï¼Œå¯¹æ—¥æ”¶ç›Šç‡è¿›è¡Œåˆ†ç»„ç»Ÿè®¡ï¼š

```{r paged.print=TRUE}
returns %>%
  mutate(ret = ret * 100) %>%
  group_by(year = year(date)) %>%
  summarise(across(ret,
    list(
      daily_mean = mean,
      daily_sd = sd,
      daily_min = min,
      daily_max = max
    ),
    .names = "{.fn}"
  )) %>% 
  print(n = Inf)
```

## å¤šä¸ªè‚¡ç¥¨åˆ†æ

åŸºäºæ•´æ´æ•°æ®[@wickham2014]çš„ç‰¹ç‚¹ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿åœ°å°†å•ä¸ªè‚¡ç¥¨çš„åˆ†ææ‹“å±•åˆ°å¤šä¸ªè‚¡ç¥¨ã€‚æ¥ä¸‹æ¥åˆ†æç›®å‰[é“ç¼æ–¯å·¥ä¸šæŒ‡æ•°](https://en.wikipedia.org/wiki/Dow_Jones_Industrial_Average)ä¸­æ‰€æœ‰çš„æˆåˆ†è‚¡ï¼š

```{r message=FALSE, warning=FALSE}
ticker <- tq_index("DOW") # è·å–æˆåˆ†è‚¡ä¿¡æ¯
ticker
```

è·å–æ‰€æœ‰æˆåˆ†è‚¡åœ¨2000-01-01åˆ°2022-06-30çš„è‚¡ç¥¨ä¿¡æ¯ï¼š

```{r}
index_prices <- tq_get(ticker,
                       get = "stock.prices",
                       from = "2000-01-01",
                       to = "2022-06-30")
index_prices
```

å…±è·å¾—äº†æ¥è‡ª30å®¶å…¬å¸çš„`r nrow(index_prices)`è¡Œæ•°æ®ï¼Œå¯¹è°ƒæ•´ä»·æ ¼è¿›è¡Œå¯è§†åŒ–ï¼ŒæŸ¥çœ‹æ€»ä½“èµ°åŠ¿ï¼š

```{r}
index_prices %>% 
  ggplot(aes(date, adjusted, color = symbol)) +
  geom_line() +
  labs(x = NULL, y = NULL, color = NULL,
       title = "DOW index stock prices",
       subtitle = "Prices in USD, adjusted for dividend payments and stock splits") +
  theme(legend.position = "none")
```

å¯¹30å®¶å…¬å¸çš„æ—¥æ”¶ç›Šç‡è¿›è¡Œæ±‡æ€»ç»Ÿè®¡ï¼š

```{r}
all_returns <- index_prices %>% 
  group_by(symbol) %>% 
  mutate(ret = adjusted / lag(adjusted) - 1) %>% 
  select(symbol, date, ret) %>% 
  drop_na(ret) %>% 
  ungroup()  # è§£é™¤åˆ†ç»„

all_returns %>% 
  mutate(ret = ret * 100) %>% 
  group_by(symbol) %>% 
  summarise(across(
    ret,
    list(
      daily_mean = mean,
      daily_sd = sd,
      daily_min = min,
      daily_max = max
    ),
    .names = "{.fn}"
  ))
```

åˆ°æ­¤ä¸ºæ­¢ï¼Œå°±å¯ä»¥ä¸‹è½½å’Œå¤„ç†ä»»æ„è‚¡ç¥¨ç»„åˆçš„ä»·æ ¼æ•°æ®äº†ã€‚æ¯”å¦‚ç”¨`ticker <- tq_index("SP500")`ä¿®æ”¹`ticker`ä¸ºæ ‡æ™®500çš„æˆåˆ†è‚¡ä¿¡æ¯ï¼Œå°±å¯ä»¥åˆ†ææ ‡æ™®500ä¸­è‚¡ç¥¨ä»·æ ¼æ•°æ®ã€‚å› ä¸ºæœ‰å¾ˆå¤šæ•°æ®éœ€è¦ä¸‹è½½ï¼Œè¿™ä¸ªæ“ä½œæ¯”è¾ƒè€—æ—¶ï¼Œè¿™é‡Œä¸æ¼”ç¤ºã€‚

## å…¶ä»–æ•°æ®æ±‡æ€»å½¢å¼

é“ç¼æ–¯æ€»äº¤æ˜“é‡ï¼š

```{r}
volume <- index_prices %>% 
  mutate(volume_usd = volume * close / 1e9) %>% 
  group_by(date) %>% 
  summarise(volume = sum(volume_usd))

volume %>% 
  ggplot(aes(date, volume)) +
  geom_line() +
  labs(x = NULL, y = NULL,
       title = "Aggregate daily trading volume in billion USD")
```

å¯åˆ©ç”¨45Â°çº¿æ¯”è¾ƒç¬¬$t$å¤©ä¸ç¬¬$t-1$å¤©çš„äº¤æ˜“é‡ï¼š

```{r warning=FALSE}
volume %>% 
  ggplot(aes(lag(volume), volume)) +
  geom_point() +
  geom_abline(aes(intercept = 0, slope = 1),
              linetype = "dotted", color = "red",
              size = .8) +
  labs(x = "Previous day aggregate trading volume (billion USD)",
       y = "Aggregate trading volume (billion USD)",
       title = "Trading volume on DOW Index versus previous day volume")
```

çº¯çº¯ç›®æµ‹å¯ä»¥å‘ç°ï¼šäº¤æ˜“é‡å¤§çš„æ—¥å­åé¢å¾€å¾€ä¹Ÿæ˜¯äº¤æ˜“é‡å¤§çš„æ—¥å­ã€‚

::: {.bd-callout .bd-callout-info}
<h4>æˆ‘çœ‹45Â°çº¿</h4>
å°†è‚¡ç¥¨ä»·æ ¼è®°ä½œ$p$ï¼Œè¿™é‡Œçš„$x$è½´ä¸º$p_{t-1}$ï¼Œ$y$è½´ä¸º$p_t$ï¼Œåœ¨ä¸€é˜¶è‡ªå›å½’æ¨¡å‹ä¸­ï¼Œ$\beta_1$ï¼ˆçº¿æ€§å›å½’ç³»æ•°ï¼‰ç›¸æ¯”45Â°çº¿å¯ä»¥æ˜¾ç¤ºæ›´å¤šä¿¡æ¯ã€‚åé¢ä½œè€…è®²æ·±å…¥åº”è¯¥ä¼šæ¶‰åŠã€‚
:::

## æŠ•èµ„ç»„åˆé—®é¢˜

æœ€ä½³æŠ•èµ„ç»„åˆè¿½æ±‚é«˜å›æŠ¥ã€ä½é£é™©ï¼š

> The standard framework for optimal portfolio selection considers investors that prefer higher future returns but dislike future return volatility (defined as the square root of the return variance): the *mean-variance investor*.

```{r}
# æ¸…æ´—æ‰è¡Œæ•°è¾ƒå°‘çš„ä¼ä¸šçš„æ‰€æœ‰è‚¡ç¥¨
index_prices <- index_prices %>% 
  group_by(symbol) %>% 
  mutate(n = n()) %>% 
  ungroup() %>% 
  filter(n == max(n)) %>% 
  select(-n)

# è®¡ç®—æ¯ä¸ªä¼ä¸šæ¯æœˆçš„å›æŠ¥ç‡
returns <- index_prices %>% 
  mutate(month = floor_date(date, "month")) %>% 
  group_by(symbol, month) %>% 
  summarise(price = last(adjusted), .groups = "drop_last") %>% 
  mutate(ret = price / lag(price) - 1) %>% 
  drop_na(ret) %>% 
  select(-price)
```

å°†æ”¶ç›Šç‡è½¬ä¸º$(T \times N)$çš„çŸ©é˜µï¼Œè®¡ç®—æ ·æœ¬å›æŠ¥ç‡å‡å€¼çŸ©é˜µ$\hat{\mu}$å’Œæ ·æœ¬åæ–¹å·®çŸ©é˜µ$\hat{\Sigma}$:
$$\hat\mu = \frac{1}{T}\sum\limits_{t=1}^T r_t$$
$$\hat\Sigma = \frac{1}{T-1}\sum\limits_{t=1}^T (r_t - \hat\mu)(r_t - \hat\mu)'$$

```{r}
return_matrix <- returns %>% 
  pivot_wider(names_from = symbol,
              values_from = ret) %>% 
  select(-month)

mu <- colMeans(return_matrix)
Sigma <- cov(return_matrix)
```

::: {.bd-callout .bd-callout-warning}
<h4>éš¾ç‚¹è­¦å‘Š</h4>
ä¸‹é¢çš„å†…å®¹ç†è§£è¿˜ä¸é€å½»ï¼Œå…ˆè®°å½•ã€‚
:::

æ¥ä¸‹æ¥è®¡ç®—æœ€å°æ–¹å·®çš„æŠ•èµ„ç»„åˆæƒé‡$\omega_\text{mvp}$å’Œå®ƒçš„é¢„æœŸæ”¶ç›Š$\omega_\text{mvp}'\mu$å’Œæ³¢åŠ¨ç‡$\sqrt{\omega_\text{mvp}'\Sigma\omega_\text{mvp}}$ã€‚$\omega_\text{mvp}$æ˜¯ä»¥ä¸‹é—®é¢˜çš„è§£ï¼š
$$\omega_\text{mvp} = \arg\min w'\Sigma w \\
\text{ s.t. } \sum\limits_{i=1}^Nw_i = 1$$

```{r}
N <- ncol(return_matrix)
iota <- rep(1, N)
mvp_weights <- solve(Sigma) %*% iota  # solveç”¨äºæ±‚é€†
mvp_weights <- mvp_weights / sum(mvp_weights)

tibble(
  expected_ret = t(mvp_weights) %*% mu,
  volatility = sqrt(t(mvp_weights) %*% Sigma %*% mvp_weights)
)
```

å°è¯•å¯»æ‰¾ä¸€ä¸ªå¯ä»¥è·å¾—ä¸‰å€äºæœ€å°æ–¹å·®ç»„åˆçš„é¢„æœŸæ”¶ç›Šçš„æŠ•èµ„ç»„åˆæƒé‡ï¼š

```{r}
mu_bar <- 3 * t(mvp_weights) %*% mu

C <- as.numeric(t(iota) %*% solve(Sigma) %*% iota)
D <- as.numeric(t(iota) %*% solve(Sigma) %*% mu)
E <- as.numeric(t(mu) %*% solve(Sigma) %*% mu)

lambda_tilde <- as.numeric(2 * (mu_bar - D / C) / (E - D^2 / C))
efp_weights <- mvp_weights +
  lambda_tilde / 2 * (solve(Sigma) %*% mu - D * mvp_weights)
```

## æœ‰æ•ˆè¾¹ç•Œ

åªè¦æœ‰ä¸¤ä¸ªæœ‰æ•ˆçš„æŠ•èµ„ç»„åˆï¼Œå°±å¯ä»¥é€šè¿‡å®ƒä»¬æƒé‡çš„çº¿æ€§ç»„åˆå¾—åˆ°æœ‰æ•ˆè¾¹ç•Œã€‚æœ‰æ•ˆè¾¹ç•Œæè¿°äº†åœ¨æ¯ä¸ªé£é™©æ°´å¹³ä¸‹å¯ä»¥å®ç°çš„æœ€é«˜é¢„æœŸæ”¶ç›Šã€‚

```{r}
c <- seq(from = -.4, to = 1.9, by = .01)
res <- tibble(
  c = c,
  mu = NA,
  sd = NA
)

for (i in seq_along(c)) {
  w <- (1 - c[i]) * mvp_weights + (c[i]) * efp_weights
  res$mu[i] <- 12 * 100 * t(w) %*% mu
  res$sd[i] <- 12 * sqrt(100) * sqrt(t(w) %*% Sigma %*% w)
}
```

```{r}
res %>% 
  ggplot(aes(sd, mu)) +
  geom_point() +
  geom_point(
    data = res %>% filter(c %in% c(0, 1)),
    size = 4
  ) +
  geom_point(
    data = tibble(
      mu = 12 * 100 * mu,
      sd = 12 * 10 * sqrt(diag(Sigma))
    ),
    aes(sd, mu), size = 1, color = "blue"
  ) +
  labs(
    x = "Annualized standard deviation (in percent)",
    y = "Annualized expected return (in percent)",
    title = "Efficient frontier for Dow Jones constituents",
    subtitle = "Thick dots indicate the location of the minimum variance and efficient tangency portfolio"
    )
```


# References

```{r data-save, eval=FALSE, include=FALSE}
# ä¸ºä¸èƒ½è¿æ¥å¤–ç½‘çš„å°ä¼™ä¼´ä¿å­˜æ•°æ®åº“ä¸­ä¸‹è½½çš„æ•°æ®
save(price, ticker, index_prices,
     file = "datas.rds")
```



